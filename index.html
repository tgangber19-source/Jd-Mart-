<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jd Mart | Online Grocery</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <link rel="apple-touch-icon" href="icon192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --brand: #4f46e5; --bg: #f9fafb; --text: #1f2937; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); padding-bottom: 100px; }
        
        /* HEADER */
        .header { background: white; padding: 15px 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 15px -5px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.4rem; font-weight: 800; color: var(--brand); display: flex; align-items: center; gap: 8px; }
        .profile-btn { width: 38px; height: 38px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--brand); font-size: 1.1rem; border: 1px solid var(--brand); }
        
        /* SEARCH & BANNER */
        .search-box { padding: 15px 20px; }
        .inp { width: 100%; padding: 12px 15px; border: 1px solid #e5e7eb; border-radius: 12px; font-size: 1rem; background: white; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .banner-area { padding: 0 20px; margin-bottom: 25px; overflow-x: auto; display: flex; gap: 10px; scrollbar-width: none; }
        .banner-img { width: 100%; border-radius: 12px; height: 160px; object-fit: cover; flex-shrink: 0; }

        /* CATEGORIES (FIXED GAP & TEXT) */
        .cat-row { display: flex; gap: 15px; overflow-x: auto; padding: 0 20px 20px; scrollbar-width: none; align-items: flex-start; }
        .cat-item { min-width: 85px; width: 85px; display: flex; flex-direction: column; align-items: center; cursor: pointer; flex-shrink: 0; }
        .cat-img { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb; margin-bottom: 8px; transition: 0.2s; background: white; }
        .cat-name { font-size: 0.8rem; font-weight: 600; color: #4b5563; text-align: center; line-height: 1.3; word-wrap: break-word; }
        .cat-item.active .cat-img { border-color: var(--brand); border-width: 3px; transform: scale(1.05); }
        .cat-item.active .cat-name { color: var(--brand); font-weight: 800; }

        /* PRODUCT GRID */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 0 20px; }
        .card { background: white; border-radius: 16px; overflow: hidden; border: 1px solid #f3f4f6; display: flex; flex-direction: column; }
        .card img { width: 100%; height: 140px; object-fit: contain; padding: 15px; border-bottom: 1px solid #f3f4f6; }
        .card-body { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .p-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .p-price { color: var(--brand); font-weight: 800; font-size: 1.1rem; margin-top: auto; }
        .add-btn { width: 100%; padding: 8px; background: #e0e7ff; color: var(--brand); border: none; border-radius: 8px; font-weight: 700; margin-top: 10px; cursor: pointer; }
        .qty-control { display: flex; align-items: center; justify-content: space-between; background: var(--brand); color: white; border-radius: 8px; padding: 6px; margin-top: 10px; font-weight: 700; }
        .qty-btn { background: transparent; border: none; color: white; width: 30px; font-size: 1.2rem; cursor: pointer; }

        /* FLOATING CART BAR */
        .float-cart { position: fixed; bottom: 20px; left: 15px; right: 15px; background: #1f2937; color: white; padding: 15px 20px; border-radius: 16px; display: none; justify-content: space-between; align-items: center; z-index: 900; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); animation: slideUp 0.3s; cursor: pointer; }
        
        /* MODALS (Login, Cart, Orders) */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .btm-sheet { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 25px; animation: slideUp 0.3s; max-height: 85vh; overflow-y: auto; }
        .center-modal { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 30px; animation: zoomIn 0.2s; margin-bottom: auto; margin-top: auto; }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #e5e7eb; }
        .btn-main { width: 100%; padding: 16px; background: var(--brand); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; margin-top: 15px; cursor: pointer; }
        
        /* TOAST */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 80px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 80px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="fa fa-shopping-bag"></i> Jd Mart</div>
        <div onclick="toggleProfile()" class="profile-btn">
            <i class="fa fa-user"></i>
        </div>
    </div>

    <div id="home-pg">
        <div class="search-box"><input oninput="filterProds(this.value)" class="inp" placeholder="Search rice, oil, soap..."></div>
        
        <div id="ban-area" class="banner-area"></div>

        <div id="cat-area" class="cat-row">
            <div class="cat-item active" onclick="filterCat('All')">
                <div class="cat-img" style="display:flex;align-items:center;justify-content:center;background:#e0e7ff"><i class="fa fa-th-large" style="color:var(--brand)"></i></div>
                <div class="cat-name">All</div>
            </div>
        </div>

        <div id="prod-grid" class="grid">
            <div style="grid-column:span 2; text-align:center; padding:40px; color:#9ca3af">Loading products...</div>
        </div>
    </div>

    <div id="float-cart" class="float-cart" onclick="openCart()">
        <div style="display:flex; flex-direction:column">
            <span style="font-size:0.7rem; color:#9ca3af; font-weight:700; text-transform:uppercase">Item Total</span>
            <span id="fc-total" style="font-size:1.2rem; font-weight:800">₹0</span>
        </div>
        <div style="font-weight:700; display:flex; align-items:center; gap:8px; font-size:1rem">
            View Cart <i class="fa fa-chevron-right"></i>
        </div>
    </div>

    <div id="cart-modal" class="modal-bg">
        <div class="btm-sheet">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2>My Cart</h2>
                <button onclick="closeModal('cart-modal')" style="background:#f3f4f6; border:none; width:30px; height:30px; border-radius:50%">X</button>
            </div>
            <div id="cart-items"></div>
            
            <div style="margin-top:20px; border-top:1px solid #e5e7eb; padding-top:15px">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>Subtotal</span><span id="c-sub">₹0</span></div>
                <div style="display:flex; justify-content:space-between; color:#10b981; margin-bottom:5px"><span>Delivery</span><span id="c-del">Free</span></div>
                <div style="display:flex; justify-content:space-between; font-size:1.3rem; font-weight:800"><span>Total</span><span id="c-tot">₹0</span></div>
            </div>

            <div style="margin-top:20px">
                <div id="guest-form">
                    <input id="u-name" class="inp" placeholder="Your Name" style="margin-bottom:10px">
                    <input id="u-phone" class="inp" placeholder="Phone Number" type="tel" maxlength="10" style="margin-bottom:10px">
                    <input id="u-addr" class="inp" placeholder="Address / Village Name" style="margin-bottom:10px">
                </div>
                <div id="logged-form" style="display:none; padding:15px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:10px; margin-bottom:10px; color:#166534">
                    <b>Deliver to:</b> <span id="l-name"></span><br>
                    <span id="l-addr"></span><br>
                    <small>Phone: <span id="l-phone"></span></small>
                </div>
                <button onclick="placeOrder()" id="ord-btn" class="btn-main">Place Order via Cash</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="modal-bg" style="align-items:center">
        <div class="center-modal">
            <h2 style="text-align:center; margin-bottom:20px">Welcome Login</h2>
            <input id="lg-name" class="inp" placeholder="Your Name" style="margin-bottom:15px">
            <input id="lg-phone" class="inp" placeholder="Mobile Number" type="tel" maxlength="10" style="margin-bottom:15px">
            <input id="lg-addr" class="inp" placeholder="Village / Address" style="margin-bottom:20px">
            <button onclick="doLogin()" class="btn-main">Save & Login</button>
            <button onclick="closeModal('login-modal')" style="width:100%; padding:15px; background:transparent; border:none; margin-top:10px; color:#6b7280">Skip / Cancel</button>
        </div>
    </div>

    <div id="profile-modal" class="modal-bg">
        <div class="btm-sheet">
            <div style="text-align:center; margin-bottom:30px">
                <div style="width:80px; height:80px; background:#e0e7ff; color:var(--brand); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:2rem; margin:0 auto 10px"><i class="fa fa-user"></i></div>
                <h2 id="p-name">Guest</h2>
                <p id="p-phone" style="color:#6b7280">-</p>
            </div>
            
            <h3>My Orders</h3>
            <div id="order-list" style="margin-top:15px; min-height:100px">
                <p style="color:#9ca3af; text-align:center">No orders found.</p>
            </div>

            <button onclick="doLogout()" style="width:100%; padding:15px; background:#fee2e2; color:#dc2626; border:none; border-radius:12px; font-weight:700; margin-top:30px">Logout</button>
            <button onclick="closeModal('profile-modal')" style="width:100%; padding:15px; background:white; border:1px solid #ddd; border-radius:12px; font-weight:700; margin-top:10px">Close</button>
        </div>
    </div>

    <div id="toast">Item Added to Cart</div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD8twwcxHsqPeaF45GdY14dSBMIv0UJNu4",
            databaseURL: "https://jdmart-d4409-default-rtdb.firebaseio.com",
            projectId: "jdmart-d4409",
            appId: "1:931488167884:web:877fbd682404056cad0f69"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let allProds = [], cart = {}, currentUser = null;

        // INIT
        checkUser();
        
        // LOAD DATA
        onValue(ref(db, 'products'), s => {
            const d = s.val() || {};
            allProds = Object.entries(d).map(([k,v]) => ({id:k, ...v})).filter(p => p.inStock);
            renderProds(allProds);
            updateCartUI();
        });

        onValue(ref(db, 'categories'), s => {
            const d = s.val() || {};
            const cats = Object.values(d);
            document.getElementById('cat-area').innerHTML = `
                <div class="cat-item active" onclick="filterCat('All')">
                    <div class="cat-img" style="display:flex;align-items:center;justify-content:center;background:#e0e7ff"><i class="fa fa-th-large" style="color:var(--brand)"></i></div>
                    <div class="cat-name">All</div>
                </div>` + 
                cats.map(c => `
                <div onclick="filterCat('${c.name}')" class="cat-item">
                    <img src="${c.image}" class="cat-img" onerror="this.src='https://placehold.co/100?text=Icon'">
                    <div class="cat-name">${c.name}</div>
                </div>`).join('');
        });

        onValue(ref(db, 'banners'), s => {
            const d = s.val() || {};
            document.getElementById('ban-area').innerHTML = Object.values(d).map(b => `<img src="${b.image}" class="banner-img">`).join('');
        });

        // USER FUNCTIONS
        function checkUser() {
            const u = localStorage.getItem('jd_user_login');
            if(u) {
                currentUser = JSON.parse(u);
                document.getElementById('p-name').innerText = currentUser.name;
                document.getElementById('p-phone').innerText = currentUser.phone;
                // Auto Fill Checkout
                document.getElementById('guest-form').style.display = 'none';
                document.getElementById('logged-form').style.display = 'block';
                document.getElementById('l-name').innerText = currentUser.name;
                document.getElementById('l-phone').innerText = currentUser.phone;
                document.getElementById('l-addr').innerText = currentUser.address;
            } else {
                currentUser = null;
                document.getElementById('p-name').innerText = "Guest User";
                document.getElementById('p-phone').innerText = "Not Logged In";
                document.getElementById('guest-form').style.display = 'block';
                document.getElementById('logged-form').style.display = 'none';
            }
        }

        window.toggleProfile = () => {
            if(currentUser) {
                loadOrders();
                document.getElementById('profile-modal').style.display = 'flex';
            } else {
                document.getElementById('login-modal').style.display = 'flex';
            }
        };

        window.doLogin = () => {
            const n = document.getElementById('lg-name').value;
            const p = document.getElementById('lg-phone').value;
            const a = document.getElementById('lg-addr').value;
            if(!n || !p || !a) return alert("All fields required");
            if(p.length !== 10) return alert("Invalid Phone");

            const userObj = { name:n, phone:p, address:a };
            localStorage.setItem('jd_user_login', JSON.stringify(userObj));
            
            // Save to Firebase Users
            set(ref(db, 'users/' + p), { savedAddress: userObj, email: p+'@jdmart.in' });

            closeModal('login-modal');
            checkUser();
            showToast("Login Successful!");
        };

        window.doLogout = () => {
            localStorage.removeItem('jd_user_login');
            closeModal('profile-modal');
            checkUser();
            showToast("Logged Out");
        };

        window.loadOrders = () => {
            if(!currentUser) return;
            const list = document.getElementById('order-list');
            list.innerHTML = "Loading...";
            
            onValue(ref(db, 'orders'), s => {
                const d = s.val() || {};
                const myOrders = Object.values(d).filter(o => 
                    (o.customer?.phone === currentUser.phone) || 
                    (o.address?.phone === currentUser.phone)
                ).reverse();

                if(myOrders.length === 0) {
                    list.innerHTML = "<p style='text-align:center;color:#9ca3af'>No past orders found.</p>";
                } else {
                    list.innerHTML = myOrders.map(o => `
                        <div style="background:#f9fafb; padding:15px; border-radius:10px; margin-bottom:10px; border:1px solid #eee">
                            <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                                <b>${new Date(o.timestamp).toLocaleDateString()}</b>
                                <span style="background:${o.status==='Delivered'?'#dcfce7':'#fef3c7'}; padding:2px 8px; border-radius:10px; font-size:0.8rem">${o.status}</span>
                            </div>
                            <small>${o.items.length} Items | Total: ₹${o.total}</small>
                        </div>
                    `).join('');
                }
            }, {onlyOnce: true});
        };

        // RENDER PRODS
        window.renderProds = (list) => {
            document.getElementById('prod-grid').innerHTML = list.map(p => {
                const inCart = cart[p.id] ? cart[p.id].qty : 0;
                return `
                <div class="card">
                    <img src="${p.image}" onerror="this.src='https://placehold.co/200'">
                    <div class="card-body">
                        <div class="p-title">${p.title}</div>
                        <div class="p-price">₹${p.price}</div>
                        ${inCart > 0 ? 
                            `<div class="qty-control">
                                <button class="qty-btn" onclick="modCart('${p.id}', -1)">-</button>
                                <span>${inCart}</span>
                                <button class="qty-btn" onclick="modCart('${p.id}', 1)">+</button>
                            </div>` : 
                            `<button class="add-btn" onclick="modCart('${p.id}', 1)">ADD +</button>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        // CART FUNCTIONS
        window.modCart = (id, change) => {
            if(!cart[id]) cart[id] = {qty:0};
            cart[id].qty += change;
            if(cart[id].qty <= 0) delete cart[id];
            
            if(change > 0) showToast("Item Added");
            updateCartUI(); 
            renderProds(allProds);
        };

        function updateCartUI() {
            let total = 0; let count = 0;
            Object.entries(cart).forEach(([id, item]) => {
                const product = allProds.find(p => p.id === id);
                if (product) { total += product.price * item.qty; count += item.qty; }
            });

            const bar = document.getElementById('float-cart');
            if (count > 0) {
                bar.style.display = 'flex';
                document.getElementById('fc-total').innerText = "₹" + total;
            } else { bar.style.display = 'none'; }
        }

        window.openCart = () => {
            const box = document.getElementById('cart-items');
            const items = Object.entries(cart);
            
            if(items.length === 0) {
                box.innerHTML = "<div style='text-align:center; padding:30px'>Cart is Empty!</div>";
                document.getElementById('c-tot').innerText = "₹0";
                document.getElementById('cart-modal').style.display = 'flex';
                return;
            }

            let sub = 0;
            box.innerHTML = items.map(([id, v]) => {
                const p = allProds.find(x => x.id === id);
                if(!p) return '';
                sub += p.price * v.qty;
                return `<div class="cart-item"><div><b>${p.title}</b><br><small>₹${p.price} x ${v.qty}</small></div><div>₹${p.price * v.qty}</div></div>`;
            }).join('');

            let del = sub > 599 ? 0 : 10; 
            document.getElementById('c-sub').innerText = "₹" + sub;
            document.getElementById('c-del').innerText = del === 0 ? "Free" : "₹" + del;
            document.getElementById('c-tot').innerText = "₹" + (sub + del);
            document.getElementById('cart-modal').style.display = 'flex';
        };

        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        window.placeOrder = async () => {
            let name, phone, addr;
            
            if(currentUser) {
                name = currentUser.name; phone = currentUser.phone; addr = currentUser.address;
            } else {
                name = document.getElementById('u-name').value;
                phone = document.getElementById('u-phone').value;
                addr = document.getElementById('u-addr').value;
            }
            
            if(!name || !phone || !addr) return alert("Please fill all details!");
            if(Object.keys(cart).length === 0) return alert("Cart is empty");

            const b = document.getElementById('ord-btn');
            b.innerText = "Processing..."; b.disabled = true;

            let sub = 0;
            const items = Object.entries(cart).map(([id, v]) => {
                const p = allProds.find(x => x.id === id);
                sub += p.price * v.qty;
                return { title: p.title, price: p.price, qty: v.qty, id: id };
            });
            let del = sub > 599 ? 0 : 10;

            await push(ref(db, 'orders'), {
                customer: { name, phone, address: addr },
                items: items,
                total: sub + del,
                deliveryCharge: del,
                status: "Placed",
                timestamp: Date.now()
            });
            
            if(!currentUser) {
                // Save guest user for next time locally (soft login)
                const u = {name, phone, address:addr};
                localStorage.setItem('jd_user_login', JSON.stringify(u));
                checkUser();
            }

            alert("Order Placed Successfully!");
            cart = {}; updateCartUI(); renderProds(allProds); closeModal('cart-modal');
            b.innerText = "Place Order via Cash"; b.disabled = false;
        };

        window.filterProds = (txt) => renderProds(allProds.filter(p => p.title.toLowerCase().includes(txt.toLowerCase())));
        
        window.filterCat = (cat) => {
            document.querySelectorAll('.cat-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(cat === 'All') renderProds(allProds);
            else renderProds(allProds.filter(p => p.category && (Array.isArray(p.category) ? p.category.includes(cat) : p.category == cat)));
        };

        window.showToast = (msg) => {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(() => { x.className = x.className.replace("show", ""); }, 3000);
        }
    </script>
</body>
</html>
